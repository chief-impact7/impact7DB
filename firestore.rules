rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // 인증: gw.impact7.kr 또는 impact7.kr 도메인의 인증된 Google 계정만 허용
    // $ 앵커로 도메인 뒤 추가 문자열 차단
    // =========================================================================
    function isAuthorized() {
      return request.auth != null
        && request.auth.token.email_verified == true
        && (request.auth.token.email.matches('.*@gw\\.impact7\\.kr$')
            || request.auth.token.email.matches('.*@impact7\\.kr$'));
    }

    // =========================================================================
    // 학생 마스터 컬렉션
    // =========================================================================
    match /students/{docId} {

      // 학생 문서 필수 필드
      function hasRequiredStudentFields() {
        let data = request.resource.data;
        return data.keys().hasAll(['name', 'parent_phone_1', 'branch', 'status', 'enrollments'])
          && data.name is string
          && data.name.size() > 0
          && data.parent_phone_1 is string
          && data.parent_phone_1.size() > 0
          && data.branch is string
          && data.status is string
          && data.status in ['등원예정', '재원', '실휴원', '가휴원', '퇴원']
          && data.enrollments is list;
      }

      // 허용된 필드만 포함 (알 수 없는 필드 차단)
      function hasOnlyAllowedStudentFields() {
        let allowed = [
          'name', 'level', 'school', 'grade',
          'student_phone', 'parent_phone_1', 'parent_phone_2',
          'branch', 'status', 'enrollments',
          'pause_start_date', 'pause_end_date',
          // 마이그레이션 호환: 기존 flat 필드 (normalizeEnrollments 전환 전 문서용)
          'day', 'class_type', 'level_code', 'level_symbol', 'class_number',
          'start_date', 'special_start_date', 'special_end_date'
        ];
        return request.resource.data.keys().hasOnly(allowed);
      }

      // 문서 크기 제한: 필드 수 20개 이하
      function withinSizeLimit() {
        return request.resource.data.keys().size() <= 20;
      }

      allow read: if isAuthorized();

      allow create: if isAuthorized()
        && hasRequiredStudentFields()
        && hasOnlyAllowedStudentFields()
        && withinSizeLimit();

      allow update: if isAuthorized()
        && hasRequiredStudentFields()
        && hasOnlyAllowedStudentFields()
        && withinSizeLimit();

      // 삭제는 당분간 허용 (관리 필요 시 사용, 향후 RBAC에서 admin만 허용)
      allow delete: if isAuthorized();

      // -----------------------------------------------------------------
      // 메모 서브컬렉션
      // -----------------------------------------------------------------
      match /memos/{memoId} {

        function hasRequiredMemoFields() {
          let data = request.resource.data;
          return data.keys().hasAll(['text', 'author', 'created_at'])
            && data.text is string
            && data.text.size() > 0
            && data.text.size() <= 2000
            && data.author is string;
        }

        function hasOnlyAllowedMemoFields() {
          return request.resource.data.keys().hasOnly(['text', 'author', 'created_at']);
        }

        allow read: if isAuthorized();

        allow create: if isAuthorized()
          && hasRequiredMemoFields()
          && hasOnlyAllowedMemoFields();

        // 메모는 수정 불가 (삭제 후 재작성)
        allow update: if false;

        allow delete: if isAuthorized();
      }
    }

    // =========================================================================
    // 이력 로그: 읽기 + 생성만 허용, 수정/삭제 불가 (감사 로그 무결성 보장)
    // =========================================================================
    match /history_logs/{logId} {

      function hasRequiredLogFields() {
        let data = request.resource.data;
        return data.keys().hasAll(['doc_id', 'change_type', 'before', 'after', 'google_login_id', 'timestamp'])
          && data.doc_id is string
          && data.doc_id.size() > 0
          && data.change_type is string
          && data.change_type in ['ENROLL', 'UPDATE', 'WITHDRAW']
          && data.before is string
          && data.after is string
          && data.google_login_id is string
          && data.google_login_id.size() > 0;
      }

      function hasOnlyAllowedLogFields() {
        return request.resource.data.keys().hasOnly([
          'doc_id', 'change_type', 'before', 'after', 'google_login_id', 'timestamp'
        ]);
      }

      allow read: if isAuthorized();

      allow create: if isAuthorized()
        && hasRequiredLogFields()
        && hasOnlyAllowedLogFields();

      // 감사 로그 수정/삭제 불가
      allow update, delete: if false;
    }

    // =========================================================================
    // 기본 거부: 위에 매칭되지 않는 모든 경로 차단
    // =========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
